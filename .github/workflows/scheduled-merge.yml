name: Scheduled PR Merge

on:
  schedule:
    # 21:57 UTC = 23:57 CEST (summer), 22:57 UTC = 23:57 CET (winter)
    # Both trigger, but the timezone check skips the wrong one.
    - cron: "57 21 * * *"
    - cron: "57 22 * * *"
  workflow_dispatch: # Allow manual trigger

jobs:
  merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Check Paris time
        id: tz-check
        run: |
          PARIS_HOUR=$(TZ='Europe/Paris' date +%H)
          echo "Paris hour: $PARIS_HOUR"
          if [ "$PARIS_HOUR" != "23" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "Not 23:xx in Paris, skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Merge labeled PRs
        if: steps.tz-check.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
            });

            const toMerge = pulls.filter(pr =>
              pr.labels.some(l => l.name === 'scheduled-merge')
            );

            if (toMerge.length === 0) {
              console.log('No PRs with "scheduled-merge" label found.');
              return;
            }

            for (const pr of toMerge) {
              console.log(`Merging PR #${pr.number}: ${pr.title}`);
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  merge_method: 'merge',
                });
                console.log(`Successfully merged PR #${pr.number}`);

                // Remove the label after merging
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  name: 'scheduled-merge',
                });
              } catch (error) {
                console.error(`Failed to merge PR #${pr.number}: ${error.message}`);
              }
            }
